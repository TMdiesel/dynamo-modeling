# Active Context

## 現在のフォーカス

E2E テストが完成し、重要な品質課題が発見されました。Phase 4 でのエラーハンドリング・冪等性・リトライ安全性の改善が最優先です。

## 直近の作業内容（Sprint 3.2 完了）

1. **E2E テスト実装完了**

   - HTTP 実サーバーに対する真の E2E テスト
   - 正常シナリオ：顧客登録 → 商品作成 → 注文作成 → ステータス更新
   - エラーシナリオ：在庫不足、存在しない顧客での注文エラー
   - 並行処理シナリオ：複数の並行注文での在庫競合テスト

2. **重要な問題の発見**

   - **在庫管理の競合制御問題**：在庫 5 個に対して並行注文 3 つ（各 3 個）が全て成功
   - 在庫が負数（-4 個）になる競合状態を確認
   - DynamoDB Conditional Writes による楽観的ロックが未実装

3. **エラーハンドリングの課題**
   - 全エラーが 400 BadRequest で返される不統一問題
   - ドメインエラーと HTTP ステータスコードのマッピング不完全
   - 構造化エラーレスポンスの未実装

## 🚨 Phase 4 で解決すべき課題（優先順位順）

### Critical（必須修正）

1. **在庫管理の競合制御**

   - DynamoDB Conditional Writes 実装
   - 楽観的ロック機能の追加
   - 並行処理での整合性保証

2. **構造化エラーレスポンス**

   - エラータイプ別 HTTP ステータスマッピング
   - APIError 構造体定義（Code, Message, Details, RetryAfter）
   - Presenter 層でのエラーレスポンス統一化

3. **Order 作成の冪等性**
   - Idempotency Key 機能実装
   - 重複注文防止機構
   - 処理済みリクエストの結果返却

### High（推奨修正）

4. **DynamoDB Transactions 適用**

   - 在庫減算と注文保存の原子性保証
   - 部分失敗状態の回避
   - TransactWriteItems 使用実装

5. **リトライ機構の安全化**
   - 冪等性チェック付きリトライ
   - エクスポネンシャルバックオフ
   - リトライ可能エラーの分類

## 技術的成果（完了済み）

- ✅ Clean Architecture 完全実装（全 15 エンドポイント）
- ✅ DynamoDB Single Table Design 実装
- ✅ OpenAPI 3.1 仕様書完成
- ✅ 真の E2E テスト実装（HTTP 通信ベース）
- ✅ 注文ライフサイクル実装（pending → confirmed → shipped → delivered）
- ✅ 基本的なドメインエラーハンドリング
- ✅ 依存性注入による疎結合実現

## 次のステップ（Phase 4: 品質向上）

### Day 15: エラーハンドリング統一化

- [ ] 構造化エラーレスポンス実装
- [ ] 在庫管理競合制御実装（Conditional Writes）
- [ ] エラーハンドリングの単体テスト

### Day 16: 冪等性・リトライ実装

- [ ] Idempotency Key 機能実装
- [ ] Order 作成の冪等性実装
- [ ] リトライ安全性の改善

### Day 17: トランザクション・テスト強化

- [ ] DynamoDB Transactions 適用
- [ ] E2E テスト拡張（冪等性・並行処理）
- [ ] パフォーマンス指標測定

## 学習ポイント・設計決定

1. **E2E テストの重要性**

   - 内部コンポーネントテストでは発見できない問題を検出
   - 実際の HTTP 通信での並行処理問題が明確に

2. **DynamoDB の並行制御の必要性**

   - NoSQL でも楽観的ロックが重要
   - ConditionExpression による原子性保証が必須

3. **エラーハンドリングの複雑性**

   - ドメインエラーとインフラエラーの適切な分離
   - クライアントへの適切なフィードバック設計

4. **Clean Architecture の効果**
   - 課題発見後の修正箇所が明確
   - 各層の責務分離により影響範囲が限定的

## 品質ゲート

### Phase 4 完了の必須条件

- [ ] 全 E2E テストが pass（並行処理含む）
- [ ] 在庫競合でのエラーハンドリングが適切
- [ ] 冪等性テストが成功
- [ ] レスポンス時間 95 パーセンタイル < 500ms
- [ ] テストカバレッジ > 80%

### リスクアセスメント

- **高リスク**: 在庫競合問題（100%発生、高影響）→ Day 15 で対策
- **高リスク**: 重複注文（80%発生、高影響）→ Day 16 で対策
- **中リスク**: 部分失敗状態（40%発生、高影響）→ Day 17 で対策
